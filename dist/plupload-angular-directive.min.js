/*! plupload-angular-directive 12-07-2015 */
"use strict";angular.module("plupload.directive",[]).provider("plUploadService",function(){var a={flashPath:"bower_components/plupload-angular-directive/dist/plupload.flash.swf",silverLightPath:"bower_components/plupload-angular-directive/dist/plupload.silverlight.xap",uploadPath:"upload.php"};this.setConfig=function(b,c){a[b]=c},this.getConfig=function(b){return a[b]};var b=this;this.$get=[function(){return{getConfig:b.getConfig,setConfig:b.setConfig}}]}).directive("plUpload",["$parse","$log","plUploadService","$timeout",function(a,b,c,d){return{restrict:"A",scope:{plProgressModel:"=",plFilesModel:"=",plFiltersModel:"=",plMultiParamsModel:"=",plInstance:"=",plResizeModel:"="},link:function(e,f,g){if(e.randomString=function(a,b){b=b||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var c="",d=0;a>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c},!g.id){var h=e.randomString(5);g.$set("id",h)}g.plAutoUpload||g.$set("plAutoUpload","true"),g.plMultiSelection||g.$set("plMultiSelection","true"),g.plInitDelay||g.$set("plInitDelay","false"),g.plMaxFileSize||g.$set("plMaxFileSize","10mb"),g.plUrl||g.$set("plUrl",c.getConfig("uploadPath")),g.plFlashSwfUrl||g.$set("plFlashSwfUrl",c.getConfig("flashPath")),g.plSilverlightXapUrl||g.$set("plSilverlightXapUrl",c.getConfig("silverLightPath")),"undefined"==typeof e.plFiltersModel?e.filters=[{title:"Image files",extensions:"jpg,jpeg,gif,png,tiff,pdf"}]:e.filters=e.plFiltersModel;var i={runtimes:"html5,flash,silverlight",browse_button:g.id,multi_selection:"true"==g.plMultiSelection.toLowerCase(),max_file_size:g.plMaxFileSize,url:g.plUrl,flash_swf_url:g.plFlashSwfUrl,silverlight_xap_url:g.plSilverlightXapUrl,filters:e.filters,drop_element:g.plDropElement};e.plMultiParamsModel&&(i.multipart_params=e.plMultiParamsModel),e.plResizeModel&&(i.resize=e.plResizeModel);var j="true"==g.plInitDelay.toLowerCase()?300:0;d(function(){var d=new plupload.Uploader(i);d.settings.headers=c.getConfig("headers"),d.init(),d.bind("Error",function(a,c){g.onFileError&&e.$parent.$apply(g.onFileError),b.error("Cannot upload, error: "+c.message+(c.file?", File: "+c.file.name:"")),a.refresh()}),d.bind("FilesAdded",function(b,c){e.$apply(function(){if(g.plFilesModel&&angular.forEach(c,function(a,b){e.plFilesModel||(e.plFilesModel=[]),e.plFilesModel.push(a)}),g.onFileAdded){var b=a(g.onFileAdded);b(e.$parent,{$files:c})}}),"true"==g.plAutoUpload&&d.start()}),d.bind("BeforeUpload",function(b,c){if(g.onBeforeUpload){var d=a(g.onBeforeUpload);d(e.$parent,{$file:c})}}),d.bind("FileUploaded",function(b,c,d){if(g.plFilesModel)e.$apply(function(){e.allUploaded=!1,angular.forEach(e.plFilesModel,function(b,f){if(100!=c.percent)e.allUploaded=!1;else if(c.id==b.id&&(b.response=JSON.parse(d.response),g.onFileUploaded)){var h=a(g.onFileUploaded);h(e.$parent,{$response:d,$file:c})}})});else if(!g.plFilesModel&&g.onFileUploaded){var f=a(g.onFileUploaded);e.$apply(function(){f(e.$parent,{$response:d,$file:c})})}}),d.bind("UploadProgress",function(b,c){if(g.plProgressModel&&(g.plFilesModel?e.$apply(function(){e.sum=0,angular.forEach(e.plFilesModel,function(a,b){e.sum=e.sum+a.percent}),e.plProgressModel=e.sum/e.plFilesModel.length}):e.$apply(function(){e.plProgressModel=c.percent}),g.onFileProgress)){var d=a(g.onFileProgress);e.$apply(function(){d(e.$parent,{$file:c})})}}),g.plInstance&&(e.plInstance=d),e.$on("$destroy",function(){d.destroy()})},j)}}}]);